---
title: "テストについて"
date: 2025-12-25
summary: "📝 テストのメモ..."
tags:
  - devops
  - testing
  - ci-cd
---

## 構造化されたテスト (Structured Testing)

- **影響分析 (開発前)**
- 実装前に、変更のスコープを分類し、テストの深さを決定します：
  - **ドメイン / ロジック層:** ビジネスルールや計算処理
  - **データ永続化層:** スキーマ、クエリ、インデックス設定
  - **トランスポート / インターフェース層:** API 契約（コントラクト）、ルーティング、ミドルウェア
  - **横断的関心事 (Cross-Cutting Concerns):** パフォーマンス、セキュリティ、並行処理

### テストの分類と戦略

- **単体テスト (Unit Testing) - 隔離されたロジック**

  - **対象:** Service 層や Domain 層の個々の関数 / メソッド。
  - **正常系:** 有効な入力が期待通りの出力を返すことを検証します。
  - **境界値分析 (BVA):** 最小値、最大値、および範囲外の値をテストします。
  - **エラーハンドリング:** 無効な入力に対して、システムが特定の例外やエラーを投げることを保証します。
  - **分離 (Isolation):** 外部依存（DB や API など）にはモック (Mocks) やスタブ (Stubs) を使用します。

- **統合テスト (Integration Testing) - コンポーネント間の相互作用**

  - **対象:** Repository 層およびモジュール間の通信。
  - **使い捨て環境 (Ephemeral Environments):** Docker (Testcontainers) を使用して、テスト用に本物のデータベースや Redis インスタンスをシミュレートします。
  - **状態検証:** Repository によって書き込まれたデータが正しく取得でき、スキーマ制約に従っているかを確認します。
  - **副作用:** ロジック変更後にイベント（MQ トリガーなど）が正しく動作するかを検証します。

- **API & コントラクトテスト**

  - **対象:** HTTP/gRPC のリクエストとレスポンスの挙動（ハンドラー層）。
  - **ペイロード検証:** API が不正な形式の JSON を拒否し、正しい HTTP ステータスコードを返すことを保証します。
  - **認証 / 認可:** 有効なトークンなしでは保護されたルートにアクセスできないことをテストします。
  - **E2E フロー:** リクエスト → ハンドラー → サービス → DB → レスポンス の流れを確認します。

- **継続的な品質保証 (Continuous Quality Assurance)**

  - **バグ駆動開発 (Bug-Driven Development):** バグが見つかった際、修正する前に**それを再現するテストケース**を作成し、再発を確実に防ぎます。
  - **冪等性 (Idempotency) テスト:** 同じ API や関数を複数回呼び出しても、データ状態が矛盾しないことを保証します。

- **自動化と CI パイプライン**
  - CI (GitHub Actions) を設定し、以下の場合にマージをブロックします：
    - テストが失敗した場合
    - テストカバレッジが低下した場合
    - Lint / スタイルチェックが失敗した場合
      - **デッドコード:** 宣言されたが使用されていない変数。
      - **セキュリティリスク:** ハードコードされたパスワードや、安全でない / 非推奨の関数呼び出し。

## CI/CD

### 定義

- **CI: 継続的インテグレーション (Continuous Integration)**
  - コードをプッシュするたび → テストが実行され → コードがビルドされ → 何も壊れていないことを保証します。
- **CD: 継続的デプロイ / デリバリー (Continuous Deployment / Delivery)**
  - CI が成功した後、コードがサーバーやホスティングプラットフォームに自動的にデプロイされます。

### ワークフロー

- **GitHub Actions:**
  - コードを GitHub にプッシュ
  - GitHub Actions が起動 (CI)
    - 依存関係のインストール
    - プロジェクトのビルド
    - テストの実行
  - CI が成功した場合 → デプロイジョブが実行 (CD)
  - アプリが自動的に更新される
