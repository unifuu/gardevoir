{{- $books := slice -}}

{{- /* Collect Books */ -}}
{{- range where site.RegularPages "Section" "books" -}}
    {{- if not .Params.searchHidden -}}
    {{- $books = $books | append (dict 
        "id" .File.UniqueID
        "title" .Title 
        "summary" .Summary
        "content" .Plain
        "permalink" .Permalink
        "relativeURL" .RelPermalink
        "date" (.Date.Format "2006-01-02T15:04:05Z07:00")
        "lastmod" (.Lastmod.Format "2006-01-02T15:04:05Z07:00")
        "author" (.Params.author | default "")
        "year" (.Params.year | default 0)
        "origin" (.Params.origin | default "")
        "rating" (.Params.rating | default 0)
        "finished" (.Params.finished | default false)
        "isReading" (.Params.is_reading | default false)
        "isFemale" (.Params.is_female | default false)
        "language" .Language.Lang
        "cover" (dict 
            "image" (.Params.cover.image | default "")
            "alt" (.Params.cover.alt | default .Title)
        )
        "country" (index (split .File.Dir "/") 1)
    ) -}}
    {{- end -}}
{{- end -}}

{{- /* Sort books by rating (highest first), then by date */ -}}
{{- $books = sort $books "rating" "desc" -}}

{{- /* Group books by status */ -}}
{{- $reading := slice -}}
{{- $finished := slice -}}
{{- $unfinished := slice -}}

{{- range $books -}}
    {{- if .isReading -}}
        {{- $reading = $reading | append . -}}
    {{- else if .finished -}}
        {{- $finished = $finished | append . -}}
    {{- else -}}
        {{- $unfinished = $unfinished | append . -}}
    {{- end -}}
{{- end -}}

{{- /* API Response */ -}}
{{- $response := dict 
    "meta" (dict 
        "total" (len $books)
        "reading" (len $reading)
        "finished" (len $finished)
        "unfinished" (len $unfinished)
        "generated" (now.Format "2006-01-02T15:04:05Z07:00")
        "endpoint" "books"
    )
    "data" (dict 
        "all" $books
        "reading" $reading
        "finished" $finished
        "unfinished" $unfinished
    )
-}}

{{- $response | jsonify -}}