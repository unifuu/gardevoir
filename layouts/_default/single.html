{{- define "main" }}
<article class="post-single">
  {{- /* Define supported languages and find resources */ -}} {{-
  $supportedLangs := slice "ja" "hk" "kr" -}} {{- $langResources := dict -}} {{-
  range $supportedLangs -}} {{- $res := $.Resources.GetMatch (printf
  "index.%s.md" .) -}} {{- if $res -}} {{- $langResources = merge $langResources
  (dict . $res) -}} {{- end -}} {{- end -}} {{- $hasTranslations := gt (len
  $langResources) 0 -}}

  <header class="post-header">
    {{ partial "breadcrumbs.html" . }}

    <div class="lang-toggle-container">
      {{- /* English Title */ -}}
      <h1 class="post-title entry-hint-parent" id="post-title-en">
        {{ .Title }} {{- if .Draft }}<span class="entry-hint" title="Draft"
          >Draft</span
        >{{- end }}
      </h1>

      {{- /* Translated Titles */ -}} {{- range $lang, $res := $langResources
      -}}
      <h1
        class="post-title entry-hint-parent"
        id="post-title-{{ $lang }}"
        style="display: none"
      >
        {{ $res.Params.title | default $.Title }}
      </h1>
      {{- end -}}
    </div>

    {{- /* English Description */ -}} {{- if .Description }}
    <div class="post-description" id="post-description-en">
      {{ .Description }}
    </div>
    {{- end }} {{- /* Translated Descriptions */ -}} {{- range $lang, $res :=
    $langResources -}} {{- if $res.Params.description }}
    <div
      class="post-description"
      id="post-description-{{ $lang }}"
      style="display: none"
    >
      {{ $res.Params.description }}
    </div>
    {{- end }} {{- end -}} {{- if not (.Param "hideMeta") }}
    <div class="post-meta">
      {{- /* English Meta */ -}}
      <div id="post-meta-en" style="display: inline">
        {{- partial "post_meta.html" . -}}
      </div>

      {{- /* Translated Meta */ -}} {{- range $lang, $res := $langResources -}}
      <div id="post-meta-{{ $lang }}" style="display: none">
        {{- partial "post_meta.html" $res -}}
      </div>
      {{- end -}} {{- /* Custom Translation Toggle - MUI Toggle Button Group
      Style */ -}} {{- if $hasTranslations -}} &nbsp;|&nbsp;
      <div class="lang-toggle-group" role="group" aria-label="language">
        {{- /* Flags mapping - Fixed order: ðŸ‡¬ðŸ‡§ðŸ‡¯ðŸ‡µðŸ§‹ðŸ‡°ðŸ‡· */ -}}
        {{- $flags := dict "en" "ðŸ‡¬ðŸ‡§" "ja" "ðŸ‡¯ðŸ‡µ" "hk" "ðŸ§‹" "kr" "ðŸ‡°ðŸ‡·" -}}
        {{- $langList := slice "en" "ja" "hk" "kr" -}}
        {{- $totalButtons := 0 -}}
        
        {{- /* Count total buttons */ -}}
        {{- range $langList -}}
          {{- if or (eq . "en") (index $langResources .) -}}
            {{- $totalButtons = add $totalButtons 1 -}}
          {{- end -}}
        {{- end -}}
        
        {{- $buttonIndex := 0 -}}
        {{- range $langList -}}
          {{- $lang := . -}}
          {{- $shouldRender := or (eq $lang "en") (index $langResources $lang) -}}
          {{- if $shouldRender -}}
            {{- $isFirst := eq $buttonIndex 0 -}}
            {{- $isLast := eq $buttonIndex (sub $totalButtons 1) -}}
            {{- $borderRadius := "0" -}}
            {{- if $isFirst -}}
              {{- $borderRadius = "4px 0 0 4px" -}}
            {{- else if $isLast -}}
              {{- $borderRadius = "0 4px 4px 0" -}}
            {{- end -}}
            <button 
              onclick="toggleLanguage(event, '{{ $lang }}')" 
              id="lang-btn-{{ $lang }}" 
              class="lang-toggle-btn"
              aria-label="{{ $lang }}"
              data-lang="{{ $lang }}"
              style="border-radius: {{ $borderRadius }};"
            >
              {{ index $flags $lang }}
            </button>
            {{- $buttonIndex = add $buttonIndex 1 -}}
          {{- end -}}
        {{- end -}}
      </div>
      {{- end -}}
      
      {{- partial "edit_post.html" . -}}
      {{- partial "post_canonical.html" . -}}
    </div>
    {{- end }}
  </header>

  {{- /* English Cover */ -}}
  <div id="post-cover-en">
    {{- $isHidden := (.Param "cover.hiddenInSingle") | default (.Param "cover.hidden") | default false }}
    {{- partial "cover.html" (dict "cxt" . "IsSingle" true "isHidden" $isHidden) }}
  </div>

  {{- /* Translated Covers */ -}}
  {{- range $lang, $res := $langResources -}}
  <div id="post-cover-{{ $lang }}" style="display: none">
    {{- $resHidden := ($res.Params.cover.hiddenInSingle) | default ($res.Params.cover.hidden) | default false }}
    {{- partial "cover.html" (dict "cxt" $res "IsSingle" true "isHidden" $resHidden) }}
  </div>
  {{- end -}}
  
  {{- if (.Param "ShowToc") }}
  <div id="toc-en">
    {{- partial "toc.html" . }}
  </div>
  {{- range $lang, $res := $langResources -}}
  <div id="toc-{{ $lang }}" style="display: none">
    {{- partial "toc.html" $res -}}
  </div>
  {{- end -}}
  {{- end }}

  {{- /* Content Areas */ -}}
  
  {{- /* English Content */ -}}
  <div class="post-content" id="post-content-en">
    {{- if not (.Param "disableAnchoredHeadings") }}
    {{- partial "anchored_headings.html" .Content -}}
    {{- else }}{{ .Content }}{{ end }}
  </div>

  {{- /* Translated Contents */ -}}
  {{- range $lang, $res := $langResources -}}
  <div class="post-content" id="post-content-{{ $lang }}" style="display: none">
    {{ $res.Content }}
  </div>
  {{- end -}}

  {{- if $hasTranslations -}}
  <style>
    /* MUI Toggle Button Group Container */
    .lang-toggle-group {
      display: inline-flex;
      vertical-align: middle;
      border-radius: 4px;
    }

    /* MUI Toggle Button Base Styles */
    .lang-toggle-btn {
      padding: 1px 4px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: transparent;
      font-size: 0.7rem;
      line-height: 1.2;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      color: var(--primary);
      font-weight: 500;
      position: relative;
      outline: none;
      margin-left: -1px;
      box-sizing: border-box;
    }

    .lang-toggle-btn:first-child {
      margin-left: 0;
    }

    /* Light mode - Hover effect (unselected) */
    .lang-toggle-btn:not(.active):hover {
      background: var(--tertiary);
      border-color: var(--secondary);
    }

    /* Light mode - Active (selected) state - Subtle blue accent */
    .lang-toggle-btn.active {
      background: var(--tertiary);
      color: var(--primary);
      border-color: var(--primary);
      z-index: 1;
      font-weight: 600;
    }

    /* Light mode - Active hover */
    .lang-toggle-btn.active:hover {
      background: var(--secondary);
      border-color: var(--primary);
    }

    /* Focus visible for accessibility */
    .lang-toggle-btn:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
      z-index: 2;
    }
  </style>
  <script>
    function toggleLanguage(e, selectedLang) {
      if (e) e.preventDefault();

      // MUI "Enforce value set" behavior: prevent deselecting the active button
      const currentBtn = document.getElementById(`lang-btn-${selectedLang}`);
      if (currentBtn && currentBtn.classList.contains('active')) {
        // Already selected, do nothing (enforce value set)
        return;
      }

      const langs = ['en', {{ range $lang, $res := $langResources }}'{{ $lang }}',{{ end }}];

      // Toggle Titles, Descriptions, Meta, Covers, TOC, Content
      langs.forEach(lang => {
        const title = document.getElementById(`post-title-${lang}`);
        const desc = document.getElementById(`post-description-${lang}`);
        const meta = document.getElementById(`post-meta-${lang}`);
        const cover = document.getElementById(`post-cover-${lang}`);
        const toc = document.getElementById(`toc-${lang}`);
        const content = document.getElementById(`post-content-${lang}`);
        const btn = document.getElementById(`lang-btn-${lang}`);

        if (lang === selectedLang) {
          if(title) title.style.display = 'block';
          if(desc) desc.style.display = 'block';
          if(meta) meta.style.display = 'inline';
          if(cover) cover.style.display = 'block';
          if(toc) toc.style.display = 'block';
          if(content) content.style.display = 'block';
          if(btn) {
            // Add active class for MUI styling
            btn.classList.add('active');
          }
        } else {
          if(title) title.style.display = 'none';
          if(desc) desc.style.display = 'none';
          if(meta) meta.style.display = 'none';
          if(cover) cover.style.display = 'none';
          if(toc) toc.style.display = 'none';
          if(content) content.style.display = 'none';
          if(btn) {
            // Remove active class
            btn.classList.remove('active');
          }
        }
      });

      // Persistence removed
    }

    // Initialize default language (English)
    (function() {
      toggleLanguage(null, 'en');
    })();
  </script>
  {{- end -}}

  <footer class="post-footer">
    {{- $tags := .Language.Params.Taxonomies.tag | default "tags" }}
    <ul class="post-tags">
      {{- range ($.GetTerms $tags) }}
      <li><a href="{{ .Permalink }}">{{ .LinkTitle }}</a></li>
      {{- end }}
    </ul>
    {{- if (.Param "ShowPostNavLinks") }} {{- partial "post_nav_links.html" . }}
    {{- end }} {{- if (and site.Params.ShowShareButtons (ne .Params.disableShare
    true)) }} {{- partial "share_icons.html" . -}} {{- end }}
  </footer>

  {{- if (.Param "comments") }} {{- partial "comments.html" . }} {{- end }}
</article>
{{- end }}{{/* end main */}}
