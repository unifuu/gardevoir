{{ define "main" }}

<header class="page-header">
  <h1>{{ .Title }}</h1>
  {{ with .Description }}<p>{{ . }}</p>{{ end }}
</header>

{{/* =========================================================
====================== Playing ===========================
========================================================= */}}

<div id="games-list-container">
  <div id="games-original-view">
    {{/* =========================================================
    ====================== Playing ===========================
    ========================================================= */}}

    {{ $playing := where .Pages "Params.finished" "ne" true }}

    {{ if gt (len $playing) 0 }}
    <details class="games-year-block games-playing-block" open>
      <summary class="games-year-header">
        <div class="filter-info">
          <span class="games-year-title">Playing</span>
          <span class="games-year-count">· {{ len $playing }} games</span>
        </div>
      </summary>

      <div class="game-grid">
        {{ range sort $playing "Title" }}
        <article class="game-card {{ if ge .Params.rating 10 }}is-masterpiece{{ end }}"
          data-platforms="{{ with .Params.platform }}{{ range $i, $p := . }}{{ if $i }},{{ end }}{{ $p | lower }}{{ end }}{{ end }}"
          data-origin="{{ .Params.origin | lower }}" data-developer="{{ .Params.developer | lower }}">
          <div class="game-card-content">
            <div class="game-cover-wrapper">
              {{ with .Params.cover.image }}
              <img src="{{ . }}" alt="{{ $.Title }}" loading="lazy">
              {{ end }}
              {{ with .Params.rating }}
              <span class="game-rating-badge">{{ . }}</span>
              {{ end }}
            </div>

            <h3 class="game-title">{{ .Title }}</h3>

            {{ if or .Params.origin .Params.aliases }}
            <p class="game-origin">
              {{ with .Params.origin }}<span class="game-flag" data-filter-type="origin"
                data-filter-value="{{ . | lower }}">{{ . }}</span>{{ end }}
              {{ with .Params.aliases }}<span class="game-alias">{{ index . 0 }}</span>{{ end }}
            </p>
            {{ end }}

            <p class="game-meta">
              <span class="game-developer" data-filter-type="developer"
                data-filter-value="{{ .Params.developer | lower }}">{{ .Params.developer }}</span> · {{ .Params.year }}
            </p>

            {{ with .Params.platform }}
            <div class="game-platforms">
              {{ range . }}
              <span class="game-platform {{ . | urlize }}" data-filter-type="platform"
                data-filter-value="{{ . | lower }}">{{ . }}</span>
              {{ end }}
            </div>
            {{ end }}
          </div>
        </article>
        {{ end }}
      </div>
    </details>
    {{ end }}

    {{/* =========================================================
    ====================== Finished ==========================
    ========================================================= */}}

    {{ $finished := where (where .Pages "Params.finished" true) "Date" "gt" (time "0002-01-01") }}

    {{/* ---------- group by year ---------- */}}
    {{ $years := newScratch }}
    {{ $yearList := slice }}

    {{ range $finished }}
    {{ $y := .Date.Format "2006" }}
    {{ $existing := $years.Get $y }}

    {{ if not $existing }}
    {{ $years.Set $y (slice .) }}
    {{ $yearList = $yearList | append $y }}
    {{ else }}
    {{ $tmp := slice }}
    {{ range $existing }}{{ $tmp = $tmp | append . }}{{ end }}
    {{ $tmp = $tmp | append . }}
    {{ $years.Set $y $tmp }}
    {{ end }}
    {{ end }}

    {{ $yearList = sort $yearList "value" "desc" }}

    {{/* ---------- render years ---------- */}}
    {{ range $yearList }}
    {{ $year := . }}
    {{ $yearGames := $years.Get $year }}

    <details class="games-year-block" open>
      <summary class="games-year-header">
        <div class="filter-info">
          <span class="games-year-title">{{ $year }}</span>
          <span class="games-year-count">· {{ len $yearGames }} games</span>
        </div>
      </summary>

      {{/* ===== group by month ===== */}}
      {{ $months := newScratch }}
      {{ $monthList := slice }}

      {{ range $yearGames }}
      {{ $m := .Date.Format "01" }}
      {{ $existing := $months.Get $m }}

      {{ if not $existing }}
      {{ $months.Set $m (slice .) }}
      {{ $monthList = $monthList | append $m }}
      {{ else }}
      {{ $tmp := slice }}
      {{ range $existing }}{{ $tmp = $tmp | append . }}{{ end }}
      {{ $tmp = $tmp | append . }}
      {{ $months.Set $m $tmp }}
      {{ end }}
      {{ end }}

      {{ $monthList = sort $monthList "value" "desc" }}

      {{ range $monthList }}
      {{ $month := . }}
      {{ $monthGames := $months.Get $month }}

      <details class="games-month-block" open>
        <summary class="games-month-header">
          <div class="filter-info">
            <span class="games-month-title">
              {{ (time (printf "%s-%s-01" $year $month)).Format "January" }}
            </span>
            <span class="games-month-count">
              · {{ len $monthGames }} games
            </span>
          </div>
        </summary>

        <div class="game-grid">
          {{ range sort $monthGames "Date" "desc" }}
          <article class="game-card {{ if ge .Params.rating 10 }}is-masterpiece{{ end }}"
            data-platforms="{{ with .Params.platform }}{{ range $i, $p := . }}{{ if $i }},{{ end }}{{ $p | lower }}{{ end }}{{ end }}"
            data-origin="{{ .Params.origin | lower }}" data-developer="{{ .Params.developer | lower }}">
            <div class="game-card-content">

              <div class="game-cover-wrapper">
                {{ with .Params.cover.image }}
                <img src="{{ . }}" alt="{{ $.Title }}" loading="lazy">
                {{ end }}
                {{ with .Params.rating }}
                <span class="game-rating-badge">{{ . }}</span>
                {{ end }}
              </div>

              <h3 class="game-title">{{ .Title }}</h3>

              {{ if or .Params.origin .Params.aliases }}
              <p class="game-origin">
                {{ with .Params.origin }}<span class="game-flag" data-filter-type="origin"
                  data-filter-value="{{ . | lower }}">{{ . }}</span>{{ end }}
                {{ with .Params.aliases }}<span class="game-alias">{{ index . 0 }}</span>{{ end }}
              </p>
              {{ end }}

              <p class="game-meta">
                <span class="game-developer" data-filter-type="developer"
                  data-filter-value="{{ .Params.developer | lower }}">{{ .Params.developer }}</span> · {{ .Params.year
                }}
              </p>
              <p class="game-finished">{{ .Date | time.Format "Jan 2, 2006" }}</p>
              {{ with .Params.platform }}
              <div class="game-platforms">
                {{ range . }}
                <span class="game-platform {{ . | urlize }}" data-filter-type="platform"
                  data-filter-value="{{ . | lower }}">{{ . }}</span>
                {{ end }}
              </div>
              {{ end }}
            </div>
          </article>
          {{ end }}
        </div>
      </details>
      {{ end }}
    </details>
    {{ end }}
  </div>

  <div id="games-filter-view" style="display: none;">
    <div class="filter-header">
      <div class="filter-info">
        <span id="filter-display-name" class="filter-title">Platform</span>
        <span id="filter-game-count" class="filter-count">· 0 games</span>
      </div>
      <button id="reset-filter" class="reset-button">✖️</button>
    </div>
    <div id="filtered-grid" class="game-grid">
      <!-- Filtered games will be cloned here -->
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const originalView = document.getElementById('games-original-view');
    const filterView = document.getElementById('games-filter-view');
    const filteredGrid = document.getElementById('filtered-grid');
    const displayNameNode = document.getElementById('filter-display-name');
    const gameCountNode = document.getElementById('filter-game-count');
    const resetButton = document.getElementById('reset-filter');

    const allCards = Array.from(originalView.querySelectorAll('.game-card'));

    function applyFilter(type, value, displayLabel) {
      filteredGrid.innerHTML = '';
      const valueLower = value.toLowerCase();

      const matches = allCards.filter(card => {
        if (type === 'platform') {
          const platforms = card.dataset.platforms.split(',');
          return platforms.includes(valueLower);
        } else {
          return card.getAttribute(`data-${type}`) === valueLower;
        }
      });

      const uniqueMatches = [];
      const seenTitles = new Set();

      matches.forEach(card => {
        const title = card.querySelector('.game-title').innerText;
        if (!seenTitles.has(title)) {
          seenTitles.add(title);
          uniqueMatches.push(card.cloneNode(true));
        }
      });

      uniqueMatches.forEach(match => {
        filteredGrid.appendChild(match);
        attachListeners(match);
      });

      // Format platform display name
      displayNameNode.innerText = (type === 'platform') ? displayLabel.toUpperCase() : displayLabel;
      gameCountNode.innerText = `· ${uniqueMatches.length} games`;

      originalView.style.display = 'none';
      filterView.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function attachListeners(container) {
      container.querySelectorAll('[data-filter-type]').forEach(el => {
        el.style.cursor = 'pointer';
        el.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          applyFilter(el.dataset.filterType, el.dataset.filterValue, el.innerText);
        };
      });
    }

    // Initial attachment
    allCards.forEach(card => attachListeners(card));

    resetButton.addEventListener('click', () => {
      filterView.style.display = 'none';
      originalView.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });
</script>

{{ end }}