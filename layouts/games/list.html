{{ define "main" }}

<header class="page-header">
  <div class="header-content">
    <h1>{{ .Title }}</h1>
    <div class="view-switch-container">
      <label class="mui-switch" title="Toggle Timeline/Rating View">
        <input type="checkbox" id="view-toggle-input">
        <span class="mui-switch-slider">
          <span class="mui-switch-thumb">
            <!-- Clock Icon (Timeline) -->
            <svg class="icon-timeline" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <!-- Star Icon (Rating) -->
            <svg class="icon-rating" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
              </polygon>
            </svg>
          </span>
        </span>
      </label>
    </div>
  </div>
  {{ with .Description }}<p>{{ . }}</p>{{ end }}
</header>

{{/* =========================================================
====================== Playing ===========================
========================================================= */}}

<div id="games-list-container">
  <div id="games-original-view">
    {{/* =========================================================
    ====================== Playing ===========================
    ========================================================= */}}

    {{ $playing := slice }}
    {{ range .Pages }}
      {{ $params := .Params }}
      {{ if not $params.is_playing }}
        {{ range .Translations }}
          {{ if eq .Lang "en" }}
            {{ $params = merge .Params $params }}
          {{ end }}
        {{ end }}
      {{ end }}
      
      {{ if $params.is_playing }}
        {{ $playing = $playing | append (dict "page" . "params" $params) }}
      {{ end }}
    {{ end }}

    {{ if gt (len $playing) 0 }}
    <details class="games-year-block games-playing-block" open>
      <summary class="games-year-header">
        <div class="filter-info">
          <span class="games-year-title">{{ i18n "playing" | default "Playing" }}</span>
          <span class="games-year-count">¬∑ {{ i18n "games_count" (dict "Count" (len $playing)) }}</span>
        </div>
      </summary>

      <div class="game-grid">
        {{ range sort $playing "page.Title" }}
        {{- $game := .page -}}
        {{- $params := .params -}}
        {{- $glow := "" -}}
        {{- $colors := slice -}}
        {{- $flag := $params.origin -}}
        {{- if eq $flag "üá©üá™" -}}
          {{- $colors = slice "#000000" "#DD0000" "#FFCE00" -}}
        {{- else if eq $flag "üá¨üáß" -}}
          {{- $colors = slice "#012169" "#FFFFFF" "#C8102E" -}}
        {{- else if eq $flag "üá´üá∑" -}}
          {{- $colors = slice "#0055A4" "#FFFFFF" "#EF4135" -}}
        {{- else if eq $flag "üáÆüáπ" -}}
          {{- $colors = slice "#009246" "#FFFFFF" "#CE2B37" -}}
        {{- else if eq $flag "üá∑üá∫" -}}
          {{- $colors = slice "#FFFFFF" "#0039A6" "#D52B1E" -}}
        {{- else if eq $flag "üá∞üá∑" -}}
          {{- $colors = slice "#FFFFFF" "#C60C30" "#003478" -}}
        {{- else if eq $flag "üá®üá¥" -}}
          {{- $colors = slice "#FCD116" "#003893" "#CE1126" -}}
        {{- else if eq $flag "üá®üáø" -}}
          {{- $colors = slice "#FFFFFF" "#D7141A" "#11457E" -}}
        {{- else if eq $flag "üáØüáµ" -}}
          {{- $colors = slice "#FFFFFF" "#BC002D" -}}
        {{- else if eq $flag "üáµüá±" -}}
          {{- $colors = slice "#FFFFFF" "#DC143C" -}}
        {{- else if eq $flag "üá®üá≥" -}}
          {{- $colors = slice "#DE2910" "#FFDE00" -}}
        {{- else if eq $flag "üá∫üá∏" -}}
          {{- $colors = slice "#B22234" "#FFFFFF" "#3C3B6E" -}}
        {{- else if eq $flag "üá∏üá™" -}}
          {{- $colors = slice "#006AA7" "#FECC00" -}}
        {{- end -}}
        {{- if eq (len $colors) 2 -}}
          {{- $c1 := index $colors 0 -}}
          {{- $c2 := index $colors 1 -}}
          {{- $shadows := slice -}}
          {{- if eq $c1 "#000000" -}}
            {{- $shadows = $shadows | append "-6px 0 12px -3px rgba(255,255,255,0.3)" -}}
            {{- $shadows = $shadows | append "-6px 0 8px -3px #000000" -}}
          {{- else if eq $c1 "#FFFFFF" -}}
            {{- $shadows = $shadows | append "-6px 0 12px -3px rgba(0,0,0,0.3)" -}}
            {{- $shadows = $shadows | append "-6px 0 8px -3px #FFFFFF" -}}
          {{- else -}}
            {{- $shadows = $shadows | append (printf "-6px 0 12px -3px %s" $c1) -}}
          {{- end -}}
          {{- if eq $c2 "#000000" -}}
            {{- $shadows = $shadows | append "6px 0 12px -3px rgba(255,255,255,0.3)" -}}
            {{- $shadows = $shadows | append "6px 0 8px -3px #000000" -}}
          {{- else if eq $c2 "#FFFFFF" -}}
            {{- $shadows = $shadows | append "6px 0 12px -3px rgba(0,0,0,0.3)" -}}
            {{- $shadows = $shadows | append "6px 0 8px -3px #FFFFFF" -}}
          {{- else -}}
            {{- $shadows = $shadows | append (printf "6px 0 12px -3px %s" $c2) -}}
          {{- end -}}
          {{- $glow = delimit $shadows ", " -}}
        {{- else if ge (len $colors) 3 -}}
          {{- $c1 := index $colors 0 -}}
          {{- $c2 := index $colors 1 -}}
          {{- $c3 := index $colors 2 -}}
          {{- $shadows := slice -}}
          {{- if eq $c1 "#000000" -}}
            {{- $shadows = $shadows | append "-8px 0 12px -3px rgba(255,255,255,0.3)" -}}
            {{- $shadows = $shadows | append "-8px 0 8px -3px #000000" -}}
          {{- else if eq $c1 "#FFFFFF" -}}
            {{- $shadows = $shadows | append "-8px 0 12px -3px rgba(0,0,0,0.3)" -}}
            {{- $shadows = $shadows | append "-8px 0 8px -3px #FFFFFF" -}}
          {{- else -}}
            {{- $shadows = $shadows | append (printf "-8px 0 12px -3px %s" $c1) -}}
          {{- end -}}
          {{- if eq $c2 "#000000" -}}
            {{- $shadows = $shadows | append "0 0 12px rgba(255,255,255,0.3)" -}}
            {{- $shadows = $shadows | append "0 0 8px #000000" -}}
          {{- else if eq $c2 "#FFFFFF" -}}
            {{- $shadows = $shadows | append "0 0 12px rgba(0,0,0,0.3)" -}}
            {{- $shadows = $shadows | append "0 0 8px #FFFFFF" -}}
          {{- else -}}
            {{- $shadows = $shadows | append (printf "0 0 12px %s" $c2) -}}
          {{- end -}}
          {{- if eq $c3 "#000000" -}}
            {{- $shadows = $shadows | append "8px 0 12px -3px rgba(255,255,255,0.3)" -}}
            {{- $shadows = $shadows | append "8px 0 8px -3px #000000" -}}
          {{- else if eq $c3 "#FFFFFF" -}}
            {{- $shadows = $shadows | append "8px 0 12px -3px rgba(0,0,0,0.3)" -}}
            {{- $shadows = $shadows | append "8px 0 8px -3px #FFFFFF" -}}
          {{- else -}}
            {{- $shadows = $shadows | append (printf "8px 0 12px -3px %s" $c3) -}}
          {{- end -}}
          {{- $glow = delimit $shadows ", " -}}
        {{- end -}}

        <a href="{{ $game.RelPermalink }}" class="game-card-link">
          <article class="game-card {{ if ge $params.rating 10 }}is-masterpiece{{ end }}"
            style="--hover-glow: {{ $glow | safeCSS }};"
            data-platforms="{{ with $params.platform }}{{ range $i, $p := . }}{{ if $i }},{{ end }}{{ $p | lower }}{{ end }}{{ end }}"
            data-rating="{{ $params.rating | default 0 }}" data-origin="{{ $params.origin | lower }}"
            data-developer="{{ $params.developer | lower }}">
            <div class="game-card-content">
              <div class="game-cover-wrapper">
                {{ with $params.cover.image }}
                <img src="{{ . }}" alt="{{ $game.Title }}" loading="lazy">
                {{ end }}
                {{ with $params.rating }}
                <span class="game-rating-badge">{{ . }}</span>
                {{ end }}
              </div>

              <h3 class="game-title">{{ $game.Title }}</h3>

              {{ if or $params.origin $params.aliases }}
              <p class="game-origin">
                {{ with $params.origin }}<span class="game-flag" data-filter-type="origin"
                  data-filter-value="{{ . | lower }}">{{ . }}</span>{{ end }}
                {{ with $params.aliases }}<span class="game-alias">{{ index . 0 }}</span>{{ end }}
              </p>
              {{ end }}

              <p class="game-meta">
                <span class="game-developer" data-filter-type="developer"
                  data-filter-value="{{ $params.developer | lower }}">{{ $params.developer }}</span> ¬∑ {{ $params.year }}
              </p>

              {{ with $params.platform }}
              <div class="game-platforms">
                {{ range . }}
                <span class="game-platform {{ . | urlize }}" data-filter-type="platform"
                  data-filter-value="{{ . | lower }}">{{ . }}</span>
                {{ end }}
              </div>
              {{ end }}
            </div>
          </article>
        </a>
        {{ end }}
      </div>
    </details>
    {{ end }}

    {{/* =========================================================
    ====================== Finished ==========================
    ========================================================= */}}

    {{/* Build a collection that expands games with dates arrays */}}
    {{ $allGameEntries := slice }}
    {{ range $page := .Pages }}
      {{ $params := $page.Params }}
      {{ if not $params.dates }}
        {{ range $page.Translations }}
          {{ if eq .Lang "en" }}
            {{ $params = merge .Params $params }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if not $params.is_playing }}
        {{ if $params.dates }}
          {{/* Game has dates array - create an entry for each date */}}
          {{ range $params.dates }}
            {{ $dateObj := time . }}
            {{ if gt $dateObj (time "0002-01-01") }}
              {{ $entry := dict "page" $page "params" $params "displayDate" $dateObj }}
              {{ $allGameEntries = $allGameEntries | append $entry }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{/* Sort all entries by date descending */}}
    {{ $allGameEntries = sort $allGameEntries "displayDate" "desc" }}

    {{/* ---------- group by year ---------- */}}
    {{ $years := newScratch }}
    {{ $yearList := slice }}

    {{ range $allGameEntries }}
    {{ $y := .displayDate.Format "2006" }}
    {{ $existing := $years.Get $y }}

    {{ if not $existing }}
    {{ $years.Set $y (slice .) }}
    {{ $yearList = $yearList | append $y }}
    {{ else }}
    {{ $tmp := slice }}
    {{ range $existing }}{{ $tmp = $tmp | append . }}{{ end }}
    {{ $tmp = $tmp | append . }}
    {{ $years.Set $y $tmp }}
    {{ end }}
    {{ end }}

    {{ $yearList = sort $yearList "value" "desc" }}

    {{/* ---------- render years ---------- */}}
    {{ range $yearList }}
    {{ $year := . }}
    {{ $yearGames := $years.Get $year }}

    <details class="games-year-block" open>
      <summary class="games-year-header">
        <div class="filter-info">
          <span class="games-year-title">{{ $year }}</span>
          <span class="games-year-count">¬∑ {{ i18n "games_count" (dict "Count" (len $yearGames)) }}</span>
        </div>
      </summary>

      {{/* ===== group by month ===== */}}
      {{ $months := newScratch }}
      {{ $monthList := slice }}

      {{ range $yearGames }}
      {{ $m := .displayDate.Format "01" }}
      {{ $monthKey := printf "%s" $m }}
      {{ $existing := $months.Get $monthKey }}

      {{ if not $existing }}
      {{ $months.Set $monthKey (slice .) }}
      {{ $monthList = $monthList | append $m }}
      {{ else }}
      {{ $tmp := slice }}
      {{ range $existing }}{{ $tmp = $tmp | append . }}{{ end }}
      {{ $tmp = $tmp | append . }}
      {{ $months.Set $monthKey $tmp }}
      {{ end }}
      {{ end }}

      {{ $monthList = sort $monthList "value" "desc" }}

      {{ range $monthList }}
      {{ $month := . }}
      {{ $monthGames := $months.Get $month }}

      <details class="games-month-block" open>
        <summary class="games-month-header">
          <div class="filter-info">
            <span class="games-month-title">
              {{ if eq site.Language.Lang "ja" }}
                {{ (index $monthGames 0).displayDate.Format "1" }}Êúà
              {{ else }}
                {{ (index $monthGames 0).displayDate.Format "January" }}
              {{ end }}
            </span>
            <span class="games-month-count">
              ¬∑ {{ i18n "games_count" (dict "Count" (len $monthGames)) }}
            </span>
          </div>
        </summary>

        <div class="game-grid">
          {{ range sort $monthGames "displayDate" "desc" }}
          {{- $game := .page -}}
          {{- $params := .params -}}
          {{- $currentDate := .displayDate -}}
          {{- $glow := "" -}}
          {{- $colors := slice -}}
          {{- $flag := $params.origin -}}
          {{- if eq $flag "üá©üá™" -}}
            {{- $colors = slice "#000000" "#DD0000" "#FFCE00" -}}
          {{- else if eq $flag "üá¨üáß" -}}
            {{- $colors = slice "#012169" "#FFFFFF" "#C8102E" -}}
          {{- else if eq $flag "üá´üá∑" -}}
            {{- $colors = slice "#0055A4" "#FFFFFF" "#EF4135" -}}
          {{- else if eq $flag "üáÆüáπ" -}}
            {{- $colors = slice "#009246" "#FFFFFF" "#CE2B37" -}}
          {{- else if eq $flag "üá∑üá∫" -}}
            {{- $colors = slice "#FFFFFF" "#0039A6" "#D52B1E" -}}
          {{- else if eq $flag "üá∞üá∑" -}}
            {{- $colors = slice "#FFFFFF" "#C60C30" "#003478" -}}
          {{- else if eq $flag "üá®üá¥" -}}
            {{- $colors = slice "#FCD116" "#003893" "#CE1126" -}}
          {{- else if eq $flag "üá®üáø" -}}
            {{- $colors = slice "#FFFFFF" "#D7141A" "#11457E" -}}
          {{- else if eq $flag "üáØüáµ" -}}
            {{- $colors = slice "#FFFFFF" "#BC002D" -}}
          {{- else if eq $flag "üáµüá±" -}}
            {{- $colors = slice "#FFFFFF" "#DC143C" -}}
          {{- else if eq $flag "üá®üá≥" -}}
            {{- $colors = slice "#DE2910" "#FFDE00" -}}
          {{- else if eq $flag "üá∫üá∏" -}}
            {{- $colors = slice "#B22234" "#FFFFFF" "#3C3B6E" -}}
          {{- else if eq $flag "üá∏üá™" -}}
            {{- $colors = slice "#006AA7" "#FECC00" -}}
          {{- end -}}
          {{- if eq (len $colors) 2 -}}
            {{- $c1 := index $colors 0 -}}
            {{- $c2 := index $colors 1 -}}
            {{- $shadows := slice -}}
            {{- if eq $c1 "#000000" -}}
              {{- $shadows = $shadows | append "-6px 0 12px -3px rgba(255,255,255,0.3)" -}}
              {{- $shadows = $shadows | append "-6px 0 8px -3px #000000" -}}
            {{- else if eq $c1 "#FFFFFF" -}}
              {{- $shadows = $shadows | append "-6px 0 12px -3px rgba(0,0,0,0.3)" -}}
              {{- $shadows = $shadows | append "-6px 0 8px -3px #FFFFFF" -}}
            {{- else -}}
              {{- $shadows = $shadows | append (printf "-6px 0 12px -3px %s" $c1) -}}
            {{- end -}}
            {{- if eq $c2 "#000000" -}}
              {{- $shadows = $shadows | append "6px 0 12px -3px rgba(255,255,255,0.3)" -}}
              {{- $shadows = $shadows | append "6px 0 8px -3px #000000" -}}
            {{- else if eq $c2 "#FFFFFF" -}}
              {{- $shadows = $shadows | append "6px 0 12px -3px rgba(0,0,0,0.3)" -}}
              {{- $shadows = $shadows | append "6px 0 8px -3px #FFFFFF" -}}
            {{- else -}}
              {{- $shadows = $shadows | append (printf "6px 0 12px -3px %s" $c2) -}}
            {{- end -}}
            {{- $glow = delimit $shadows ", " -}}
          {{- else if ge (len $colors) 3 -}}
            {{- $c1 := index $colors 0 -}}
            {{- $c2 := index $colors 1 -}}
            {{- $c3 := index $colors 2 -}}
            {{- $shadows := slice -}}
            {{- if eq $c1 "#000000" -}}
              {{- $shadows = $shadows | append "-8px 0 12px -3px rgba(255,255,255,0.3)" -}}
              {{- $shadows = $shadows | append "-8px 0 8px -3px #000000" -}}
            {{- else if eq $c1 "#FFFFFF" -}}
              {{- $shadows = $shadows | append "-8px 0 12px -3px rgba(0,0,0,0.3)" -}}
              {{- $shadows = $shadows | append "-8px 0 8px -3px #FFFFFF" -}}
            {{- else -}}
              {{- $shadows = $shadows | append (printf "-8px 0 12px -3px %s" $c1) -}}
            {{- end -}}
            {{- if eq $c2 "#000000" -}}
              {{- $shadows = $shadows | append "0 0 12px rgba(255,255,255,0.3)" -}}
              {{- $shadows = $shadows | append "0 0 8px #000000" -}}
            {{- else if eq $c2 "#FFFFFF" -}}
              {{- $shadows = $shadows | append "0 0 12px rgba(0,0,0,0.3)" -}}
              {{- $shadows = $shadows | append "0 0 8px #FFFFFF" -}}
            {{- else -}}
              {{- $shadows = $shadows | append (printf "0 0 12px %s" $c2) -}}
            {{- end -}}
            {{- if eq $c3 "#000000" -}}
              {{- $shadows = $shadows | append "8px 0 12px -3px rgba(255,255,255,0.3)" -}}
              {{- $shadows = $shadows | append "8px 0 8px -3px #000000" -}}
            {{- else if eq $c3 "#FFFFFF" -}}
              {{- $shadows = $shadows | append "8px 0 12px -3px rgba(0,0,0,0.3)" -}}
              {{- $shadows = $shadows | append "8px 0 8px -3px #FFFFFF" -}}
            {{- else -}}
              {{- $shadows = $shadows | append (printf "8px 0 12px -3px %s" $c3) -}}
            {{- end -}}
            {{- $glow = delimit $shadows ", " -}}
          {{- end -}}

          <a href="{{ $game.RelPermalink }}" class="game-card-link">
            <article class="game-card {{ if ge $params.rating 10 }}is-masterpiece{{ end }}"
              style="--hover-glow: {{ $glow | safeCSS }};"
              data-platforms="{{ with $params.platform }}{{ range $i, $p := . }}{{ if $i }},{{ end }}{{ $p | lower }}{{ end }}{{ end }}"
              data-rating="{{ $params.rating | default 0 }}" data-origin="{{ $params.origin | lower }}"
              data-developer="{{ $params.developer | lower }}">
              <div class="game-card-content">

                <div class="game-cover-wrapper">
                  {{ with $params.cover.image }}
                  <img src="{{ . }}" alt="{{ $game.Title }}" loading="lazy">
                  {{ end }}
                  {{ with $params.rating }}
                  <span class="game-rating-badge">{{ . }}</span>
                  {{ end }}
                </div>

                <h3 class="game-title">{{ $game.Title }}</h3>

                {{ if or $params.origin $params.aliases }}
                <p class="game-origin">
                  {{ with $params.origin }}<span class="game-flag" data-filter-type="origin"
                    data-filter-value="{{ . | lower }}">{{ . }}</span>{{ end }}
                  {{ with $params.aliases }}<span class="game-alias">{{ index . 0 }}</span>{{ end }}
                </p>
                {{ end }}

                <p class="game-meta">
                  <span class="game-developer" data-filter-type="developer"
                    data-filter-value="{{ $params.developer | lower }}">{{ $params.developer }}</span> ¬∑ {{ $params.year
                  }}
                </p>
                <p class="game-finished">{{ $currentDate | time.Format (default "January 2, 2006" site.Params.DateFormat) }}</p>
                {{ with $params.platform }}
                <div class="game-platforms">
                  {{ range . }}
                  <span class="game-platform {{ . | urlize }}" data-filter-type="platform"
                    data-filter-value="{{ . | lower }}">{{ . }}</span>
                  {{ end }}
                </div>
                {{ end }}
              </div>
            </article>
          </a>
          {{ end }}
        </div>
      </details>
      {{ end }}
    </details>
    {{ end }}
  </div>
  <div id="games-rating-view" style="display: none;">
    <!-- Groups by rating will be generated here -->
  </div>

  <div id="games-filter-view" style="display: none;">
    <div class="filter-header">
      <div class="filter-info">
        <span id="filter-display-name" class="filter-title">Platform</span>
        <span id="filter-game-count" class="filter-count">¬∑ 0 games</span>
      </div>
      <button id="reset-filter" class="reset-button">‚úñÔ∏è</button>
    </div>
    <div id="filtered-grid" class="game-grid">
      <!-- Filtered games will be cloned here -->
    </div>
  </div>
</div>

<style>
  .game-card-link {
    text-decoration: none;
    color: inherit;
    display: block;
    transition: transform 0.2s ease;
  }

  .game-card-link:hover {
    transform: translateY(-2px);
  }

  .game-card-link:active {
    transform: translateY(0);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const originalView = document.getElementById('games-original-view');
    const ratingView = document.getElementById('games-rating-view');
    const filterView = document.getElementById('games-filter-view');
    const filteredGrid = document.getElementById('filtered-grid');
    const displayNameNode = document.getElementById('filter-display-name');
    const gameCountNode = document.getElementById('filter-game-count');
    const resetButton = document.getElementById('reset-filter');
    const viewToggle = document.getElementById('view-toggle-input');

    const allCards = Array.from(originalView.querySelectorAll('.game-card'));
    
    // Inject localized count template (replacing placeholder in JS)
    const countTemplate = '{{ i18n "games_count" (dict "Count" "COUNT_PLACEHOLDER") }}';
    function formatGameCount(count) {
      return countTemplate.replace('COUNT_PLACEHOLDER', count);
    }

    function applyFilter(type, value, displayLabel) {
      filteredGrid.innerHTML = '';
      const valueLower = value.toLowerCase();

      const matches = allCards.filter(card => {
        if (type === 'platform') {
          const platforms = card.dataset.platforms.split(',');
          return platforms.includes(valueLower);
        } else {
          return card.getAttribute(`data-${type}`) === valueLower;
        }
      });

      const uniqueMatches = [];
      const seenTitles = new Set();

      matches.forEach(card => {
        const title = card.querySelector('.game-title').innerText;
        if (!seenTitles.has(title)) {
          seenTitles.add(title);
          const link = card.closest('.game-card-link');
          const clone = link ? link.cloneNode(true) : card.cloneNode(true);
          uniqueMatches.push(clone);
        }
      });

      uniqueMatches.forEach(match => {
        filteredGrid.appendChild(match);
        const cardInMatch = match.classList.contains('game-card') ? match : match.querySelector('.game-card');
        if (cardInMatch) attachListeners(cardInMatch);
      });

      displayNameNode.innerText = (type === 'platform') ? displayLabel.toUpperCase() : displayLabel;
      gameCountNode.innerText = `¬∑ ${formatGameCount(uniqueMatches.length)}`;

      originalView.style.display = 'none';
      ratingView.style.display = 'none';
      filterView.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function generateRatingView() {
      ratingView.innerHTML = '';

      const groups = {};
      allCards.forEach(card => {
        const r = parseInt(card.dataset.rating) || 0;
        if (!groups[r]) groups[r] = [];
        groups[r].push(card);
      });

      // Show ratings 10 to 1, then 0
      const sortedRatings = Object.keys(groups).map(Number).sort((a, b) => b - a);

      sortedRatings.forEach(r => {
        const cards = groups[r];
        const uniqueCards = [];
        const seenTitles = new Set();

        cards.forEach(card => {
          const title = card.querySelector('.game-title').innerText;
          if (!seenTitles.has(title)) {
            seenTitles.add(title);
            const link = card.closest('.game-card-link');
            const clone = link ? link.cloneNode(true) : card.cloneNode(true);
            const clonedCard = clone.classList.contains('game-card') ? clone : clone.querySelector('.game-card');
            if (clonedCard) clonedCard.style.removeProperty('--hover-glow');
            uniqueCards.push(clone);
          }
        });

        const section = document.createElement('div');
        section.className = 'rating-group';
        section.innerHTML = `
          <div class="games-year-header rating-header">
            <div class="filter-info">
              <span class="games-year-title">‚≠êÔ∏è ${r}</span>
              <span class="games-year-count">¬∑ ${formatGameCount(uniqueCards.length)}</span>
            </div>
          </div>
          <div class="game-grid"></div>
        `;

        const grid = section.querySelector('.game-grid');
        uniqueCards.forEach(c => {
          grid.appendChild(c);
          const cardInC = c.classList.contains('game-card') ? c : c.querySelector('.game-card');
          if (cardInC) attachListeners(cardInC);
        });
        ratingView.appendChild(section);
      });
    }

    function attachListeners(container) {
      container.querySelectorAll('[data-filter-type]').forEach(el => {
        el.style.cursor = 'pointer';
        el.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          applyFilter(el.dataset.filterType, el.dataset.filterValue, el.innerText);
        };
      });
    }

    // Initial attachment
    allCards.forEach(card => attachListeners(card));

    viewToggle.addEventListener('change', () => {
      if (viewToggle.checked) {
        if (!ratingView.innerHTML.trim()) {
          generateRatingView();
        }
        originalView.style.display = 'none';
        filterView.style.display = 'none';
        ratingView.style.display = 'block';
      } else {
        ratingView.style.display = 'none';
        filterView.style.display = 'none';
        originalView.style.display = 'block';
      }
    });

    resetButton.addEventListener('click', () => {
      filterView.style.display = 'none';
      if (viewToggle.checked) {
        ratingView.style.display = 'block';
      } else {
        originalView.style.display = 'block';
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });
</script>

{{ end }}